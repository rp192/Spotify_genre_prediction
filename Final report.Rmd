---
title: "Final Report"
author: "Rohit"
date: "2023-11-26"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Executive summary
## Being tasked with the responsibility of analysing and building predictive models for Spotify as their Data scientist, various insights have been drawn in the process. The model was supposed to be built by variables like the genre of the song, the track release year, speechiness, the danceable and tempo characteristics of a song. The analysis also required asnwering a few questions which are asnwered as follows-: 
1. The popularity did difffer between genres which is visualized by a box plot
2. Yes there is a difference in speeechiness between genres , the visualization depicts the clear difference , it is achieved through a box plot , another visualization was to calculate the mean distribution of speechiness and it is hence highlighted by the second bar graph.
3. Finally , yes the popularity did vary between genres which varied across the years the data is recorded.The visualization provides a clear picture of the variations.

# Method
## The data used in this analysis is a subset of the Spotify songs dataset from TidyTuesday. The data contains information about 32833 songs of different playlist/song genres on Spotify, including 23 other musical variables which give accurate insights about a specific song
1. Readin the data using readr package.
2. Selecting relevant columns
3. Omitting missing values
4. The year variable was generated by performing operations on release date variable
5.Data is sliced to 1000 rows per genre using appropriate functions
6. Factorization of variables is done.

# Results
## Model 1 (LDA)
The accuracy  of model is 0.426 and 95%CI is 0.4008. The model seems fairly accurate but not the best.

## Model 2 (KNN)
The K Nearest Neighbor (KNN) model had an accuracy of 0.476, i.e it predicted the correct genre of song 47% of time. The model performed little better than the LDA. 

# Conclusion

The data accuracy does not seem to be any high but it should be noted that predicting genre popularity based on the given features did not seem like a fair evaluation. Their is a significant overlap of the genre features. Nonetheless , our model still provides certain insights to the organization. The limitations of the model indicate that the organisation should incorporate additional relevant data for better prediction.




# Appendix
Loading libraries
```{r}
library(skimr)
library(tidyverse)
library(tidyr)
library(dplyr)
library(readr)
library(ggplot2)
library(lubridate)
library(tidymodels)
```

## Data cleaning
```{r}
spotify_songs <- read_csv('https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-21/spotify_songs.csv')
head(spotify_songs)
```

## Overview of the data
```{r}
skim_without_charts(spotify_songs)
```

## Eliminating the null values
```{r}
spotify_songs <- na.omit(spotify_songs)
```

```{r}
song_select1 <-
  dplyr::select(spotify_songs, track_popularity, playlist_genre, track_album_release_date, danceability, speechiness, tempo) %>%
  mutate(track_album_release_date = substr(track_album_release_date,1,4))

glimpse(song_select1)

song_select1$year <- as.numeric(song_select1$track_album_release_date)
song_select <- dplyr::select(song_select1, track_popularity, playlist_genre, year, danceability, speechiness, tempo)
glimpse(song_select)      
  
```
## Refactoring and slicing to 1000 rows each genre
```{r}
song_select <- song_select %>%
  group_by(playlist_genre) %>%
  sample_n(1000) %>%
  ungroup()
song_select

song_select$playlist_genre = as.factor(song_select$playlist_genre)
glimpse(song_select)
```
## Exploratory analysis
### Question 1
```{r}
ggplot(song_select, aes(x = playlist_genre, y = track_popularity, fill = playlist_genre)) +
  geom_boxplot() + labs(title = "Popularity vs Genre" , x = 'Genre', y="Popularity")

```
### It is evident that 'Pop' has the most poluarity with 'Latin' slightly less popular than pop and rest of the genre having relatively high popularity than 'EDM' which is the least popular genre. It is thus concluded that popularity differs between genres.

### Question 2
```{r}
ggplot(song_select, aes(x = playlist_genre, y = speechiness, fill = playlist_genre)) +
  geom_boxplot() +
  labs(x = "Genre", y = "Speechiness", title = "Distribution of Speechiness by Genre")

```
### The above box plot concludes that 'Rap' and 'R&B' genre has more speechiness distribution than compared to the rest. 'Rock' genre being the least. We willl also try plotting against the mean distribution of speachiness against genre.
```{r}
mean_speach<- song_select %>%
  group_by(playlist_genre) %>%
  summarise(avg = mean(speechiness) )

ggplot(mean_speach, aes(x = playlist_genre, y = avg, fill = playlist_genre)) +
  geom_bar(stat = 'identity') +
  labs(x = "Genre", y = "Speechiness", title = "Average distribution of Speechiness by Genre")

```
### The second plot further strengthens the previous conclusion.

### Question 3
```{r}
song_select %>%
  group_by(playlist_genre, year = (year)) %>%
  summarize(avg_popularity = mean(track_popularity), .groups = 'drop') %>%
  ggplot(aes(x = year, y = avg_popularity, color = playlist_genre)) +
  geom_line() +
  labs(x = "Year", y = "Average Popularity", title = "Average Song Popularity against  Year and Genre") +
  scale_color_hue(name = "Genre") +
  facet_wrap(~ playlist_genre, scales = "free_y")


```
The plot is the result of averaging popularity and grouping together with year and genre. SImple line plot is very complicated as trendlines overlap. The plot however potrays the average change in popularity of different genre over the time.

## Model 1 -: Linear Discriminant analysis
### Splitting and feature selection
```{r}
set.seed(1893161)
song_split = initial_split(song_select)
song_train = training(song_split)
song_test = testing(song_split)


```

## Generating the metrics for model 1
```{r}
glimpse(song_train)
library(MASS)
library(caret)
library(recipes)
library(yardstick)
library(tune)
library(themis)
song_lda <- lda(playlist_genre ~ ., data = song_train)
song_pred <- predict(song_lda, newdata = song_test)
confusionMatrix(song_pred$class, song_test$playlist_genre)
```

## MOdel 2 KNN
```{r}
library(recipes)
song_recipe <- recipe( playlist_genre ~ ., data = song_train ) %>%
  step_downsample( playlist_genre ) %>%
  step_rm() %>%
  prep()
song_recipe
```

```{r}
set.seed(1893161)
train_prep <- juice( song_recipe )
test_prep <- bake( song_recipe, song_test )
```

```{r}
skim_without_charts(test_prep)
```


```{r}
knn_spec <- nearest_neighbor( mode = "classification", neighbors = tune() ) %>%
  set_engine( "kknn" )
```

```{r}
model_cv <- vfold_cv( train_prep, v = 5 ,strata = playlist_genre)
k_grid <- grid_regular( neighbors( range = c( 1, 100 ) ),
                        levels = 20)
```
```{r}
knn_tune <- tune_grid(object = knn_spec,
                      preprocessor = recipe(playlist_genre ~ .,
                                            data = train_prep),
                      resamples = model_cv,
                      grid = k_grid )
```
```{r}
best_acc <- select_best( knn_tune, "accuracy")
best_acc
```
```{r}
knn_spec_final <- finalize_model( knn_spec, best_acc )
knn_spec_final
```

```{r}
spotify_knn <- knn_spec_final %>%
  fit( playlist_genre ~ . , data = train_prep )
spotify_knn
```

```{r}
knn_preds <- predict( spotify_knn,
                      test_prep,
                      type = "class" )
```
```{r}
head(tail(knn_tune %>%
            collect_metrics(),5))
```